-- GearSpawnerScript (Immediate + Timed Gear Rain with ;abuse / ;unabuse)
-- Place in ServerScriptService

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MessagingService = game:GetService("MessagingService")

-- Admin usernames
local Admins = {"Mrpizzaman987", "happymanslashsad"} -- add your usernames here

-- Gear folder
local GearFolder = ReplicatedStorage:WaitForChild("GearTemplates")

-- Config
local DROP_HEIGHT = 20
local GEARS_PER_PLAYER = 5
local RAIN_INTERVAL = 300 -- 5 minutes in seconds

-- Control flag
local raining = false

-- Shuffle utility
local function shuffle(tbl)
    local t = {table.unpack(tbl)}
    for i = #t, 2, -1 do
        local j = math.random(1, i)
        t[i], t[j] = t[j], t[i]
    end
    return t
end

-- Check if player is admin
local function isAdmin(player)
    for _, name in pairs(Admins) do
        if player.Name == name then
            return true
        end
    end
    return false
end

-- Spawn GEARS_PER_PLAYER random gears above a player
local function spawnGearsForPlayer(player)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart

    local gearList = GearFolder:GetChildren()
    if #gearList == 0 then
        warn("No gears found in GearTemplates! Error Code: 1101")
        return
    end

    local shuffledGears = shuffle(gearList)
    local spawnCount = math.min(GEARS_PER_PLAYER, #shuffledGears)

    for i = 1, spawnCount do
        local gearClone = shuffledGears[i]:Clone()
        gearClone.Parent = workspace
        gearClone.Handle.CFrame = hrp.CFrame + Vector3.new(
            math.random(-5, 5),
            DROP_HEIGHT,
            math.random(-5, 5)
        )

        -- Make gear pickable
        local touchedConnection
        touchedConnection = gearClone.Handle.Touched:Connect(function(hit)
            local hitPlayer = Players:GetPlayerFromCharacter(hit.Parent)
            if hitPlayer then
                local backpack = hitPlayer:FindFirstChild("Backpack")
                if backpack then
                    gearClone.Parent = backpack
                else
                    gearClone:Destroy()
                end
                touchedConnection:Disconnect()
            end
        end)
    end
    print("Spawned " .. spawnCount .. " gears above " .. player.Name .. " Status Code: 2100")
end

-- Rain gears above all players in this server
local function rainAllPlayers()
    for _, plr in pairs(Players:GetPlayers()) do
        spawnGearsForPlayer(plr)
    end
end

-- Timed global rain loop
task.spawn(function()
    while true do
        if raining then
            rainAllPlayers()
        end
        task.wait(RAIN_INTERVAL)
    end
end)

-- Messaging events for global control
MessagingService:SubscribeAsync("GearRainGlobalStart", function()
    raining = true
    -- Immediate first gear rain
    rainAllPlayers()
    print("Gear rain started globally! Status Code: 4000")
end)

MessagingService:SubscribeAsync("GearRainGlobalStop", function()
    raining = false
    print("Gear rain stopped globally! Status Code: 4001")
end)

-- Chat command listener
Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(msg)
        if not isAdmin(player) then return end
        local lowerMsg = msg:lower()

        if lowerMsg == ";abuse" then
            MessagingService:PublishAsync("GearRainGlobalStart", true)
        elseif lowerMsg == ";unabuse" then
            MessagingService:PublishAsync("GearRainGlobalStop", true)
        end
    end)
end)

print("GearSpawnerScript loaded. Global ;abuse (start) and ;unabuse (stop) enabled for admins only.")
