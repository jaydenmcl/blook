-- GearSpawnerScript (Global Gear Rain + Boombox with Sequential Songs & Resizing)
-- Place in ServerScriptService

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local MessagingService = game:GetService("MessagingService")
local InsertService = game:GetService("InsertService")

-- Admin usernames
local Admins = {"Mrpizzaman987", "happymanslashsad"} -- add your usernames here

-- Gear folder
local GearFolder = ReplicatedStorage:WaitForChild("GearTemplates")

-- Boombox asset ID
local BOOMBOX_ASSET_ID = 212641536 -- replace with your Boombox model asset ID

-- Config
local DROP_HEIGHT = 20
local MAX_GEARS = 15 -- maximum gears to spawn per player

-- Shuffle utility
local function shuffle(tbl)
    local t = {table.unpack(tbl)}
    for i = #t, 2, -1 do
        local j = math.random(1, i)
        t[i], t[j] = t[j], t[i]
    end
    return t
end

-- Check if player is admin
local function isAdmin(player)
    for _, name in pairs(Admins) do
        if player.Name == name then
            return true
        end
    end
    return false
end

-- Spawn up to MAX_GEARS unique gears above a player
local function spawnGearsForPlayer(player)
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character.HumanoidRootPart

    local gearList = GearFolder:GetChildren()
    if #gearList == 0 then return end

    local shuffledGears = shuffle(gearList)
    local spawnCount = math.min(MAX_GEARS, #shuffledGears)

    for i = 1, spawnCount do
        local gearClone = shuffledGears[i]:Clone()
        gearClone.Parent = Workspace
        gearClone.Handle.CFrame = hrp.CFrame + Vector3.new(
            math.random(-5,5),
            DROP_HEIGHT,
            math.random(-5,5)
        )

        -- Make gear pickable
        local touchedConnection
        touchedConnection = gearClone.Handle.Touched:Connect(function(hit)
            local hitPlayer = Players:GetPlayerFromCharacter(hit.Parent)
            if hitPlayer then
                local backpack = hitPlayer:FindFirstChild("Backpack")
                if backpack then
                    gearClone.Parent = backpack
                else
                    gearClone:Destroy()
                end
                touchedConnection:Disconnect()
            end
        end)
    end
end

-- Rain gears above all players in this server
local function rainAllPlayers()
    for _, plr in pairs(Players:GetPlayers()) do
        spawnGearsForPlayer(plr)
    end
end

-- Spawn boombox using asset ID, resize, and play two songs sequentially
local function spawnBoombox(assetId)
    local spawnPart = Workspace:FindFirstChild("BoomBoxSpawn")
    if not spawnPart then return end

    local success, assetModel = pcall(function()
        return InsertService:LoadAsset(assetId)
    end)

    if not success or not assetModel then
        warn("Failed to load Boombox asset with ID:", assetId)
        return
    end

    local boomClone = assetModel:GetChildren()[1]
    if not boomClone then return end
    boomClone.Parent = Workspace

    -- Position above spawn part
    if boomClone.PrimaryPart then
        boomClone:SetPrimaryPartCFrame(spawnPart.CFrame + Vector3.new(0, 4, 0))
        boomClone.PrimaryPart.Size = Vector3.new(58, 32, 16)
    else
        local firstPart = boomClone:FindFirstChildWhichIsA("BasePart")
        if firstPart then
            firstPart.Size = Vector3.new(58, 32, 16)
            boomClone:MoveTo(spawnPart.Position + Vector3.new(0, 4, 0))
        end
    end

    -- Function to play a song by ID
    local function playSong(songId)
        local sound = Instance.new("Sound")
        sound.SoundId = "rbxassetid://" .. songId
        sound.Parent = boomClone
        sound:Play()
        sound.Ended:Wait()
        sound:Destroy()
    end

    -- Play songs sequentially
    playSong(142376088)
    playSong(16190782181)

    -- Remove the Boombox after both songs
    boomClone:Destroy()
end

-- Global event listener
MessagingService:SubscribeAsync("GearRainGlobal", function()
    rainAllPlayers()
    spawnBoombox(BOOMBOX_ASSET_ID)
end)

-- Chat command listener
Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(msg)
        if not isAdmin(player) then return end

        local lowerMsg = msg:lower()
        if lowerMsg == ";abuse" then
            -- Send global message to all servers
            MessagingService:PublishAsync("GearRainGlobal", true)
        end
    end)
end)

print("GearSpawnerScript loaded. Global ;Abuse + Boombox enabled for admins only. Max gears per player:", MAX_GEARS)
